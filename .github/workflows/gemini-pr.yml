name: Gemini PR Workflow

on:
  workflow_dispatch:
    inputs:
      task_type:
        description: "Task type"
        required: true
        default: "architecture_rfc"
        type: choice
        options:
          - architecture_rfc
          - issue_triage
      scope:
        description: "Scoped task for Gemini (e.g. portfolio tab split RFC)"
        required: true
        type: string
      base_branch:
        description: "Base branch to branch from"
        required: false
        default: "main"
        type: string
      draft:
        description: "Create PR as draft"
        required: false
        default: true
        type: boolean
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: gemini-pr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    name: Prepare Trigger Context
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.eval.outputs.should_run }}
      scope: ${{ steps.eval.outputs.scope }}
      base_branch: ${{ steps.eval.outputs.base_branch }}
      draft: ${{ steps.eval.outputs.draft }}
      requester: ${{ steps.eval.outputs.requester }}
      trigger: ${{ steps.eval.outputs.trigger }}
      task_type: ${{ steps.eval.outputs.task_type }}
      enforce_docs_gate: ${{ steps.eval.outputs.enforce_docs_gate }}
    steps:
      - name: Evaluate event and authorization
        id: eval
        uses: actions/github-script@v7
        with:
          script: |
            const ev = context.eventName;
            core.setOutput('trigger', ev);
            if (ev === 'workflow_dispatch') {
              const inputs = context.payload.inputs || {};
              const taskType = inputs.task_type || 'architecture_rfc';
              core.setOutput('should_run', 'true');
              core.setOutput('task_type', taskType);
              core.setOutput('enforce_docs_gate', 'true');
              core.setOutput('scope', inputs.scope || 'Implement requested change');
              core.setOutput('base_branch', inputs.base_branch || 'main');
              core.setOutput('draft', String(inputs.draft ?? 'true'));
              core.setOutput('requester', context.actor);
              return;
            }

            if (ev === 'issue_comment') {
              const body = (context.payload.comment?.body || '').trim();
              const assoc = context.payload.comment?.author_association || '';
              const allowed = ['OWNER', 'MEMBER', 'COLLABORATOR'];
              const isIssue = !context.payload.issue?.pull_request;
              const bodyLower = body.toLowerCase();
              const isGeminiRfc = bodyLower.startsWith('/gemini-rfc');
              const isGeminiIssue = bodyLower.startsWith('/gemini-issue');
              if (!isIssue || (!isGeminiRfc && !isGeminiIssue) || !allowed.includes(assoc)) {
                core.setOutput('should_run', 'false');
                return;
              }

              const scopeMatch = body.match(/scope\s*=\s*(.+)$/i);
              const scope = scopeMatch ? scopeMatch[1].trim() : 'Implement requested change from issue comment';
              core.setOutput('should_run', 'true');
              core.setOutput('task_type', isGeminiIssue ? 'issue_triage' : 'architecture_rfc');
              core.setOutput('enforce_docs_gate', 'true');
              core.setOutput('scope', scope);
              core.setOutput('base_branch', 'main');
              core.setOutput('draft', 'true');
              core.setOutput('requester', context.payload.comment?.user?.login || context.actor);
              return;
            }

            core.setOutput('should_run', 'false');
            core.setOutput('task_type', 'general');
            core.setOutput('enforce_docs_gate', 'false');

  gemini_pr:
    name: Generate Changes and Open PR
    needs: prepare
    if: needs.prepare.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.base_branch }}
          fetch-depth: 0

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install clippy and rustfmt
        run: rustup component add clippy rustfmt

      - name: Prepare branch name
        id: branch
        run: |
          ts="$(date +%Y%m%d-%H%M%S)"
          safe_scope="$(echo "${{ needs.prepare.outputs.scope }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/-\+/-/g' | sed 's/^-//;s/-$//' | cut -c1-32)"
          if [ -z "$safe_scope" ]; then safe_scope="task"; fi
          echo "name=gemini/${safe_scope}-${ts}" >> "$GITHUB_OUTPUT"

      - name: Run Gemini to apply scoped changes
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            You are working in a Rust repository.
            Task scope: ${{ needs.prepare.outputs.scope }}
            Task type: ${{ needs.prepare.outputs.task_type }}

            Requirements:
            - Keep changes strictly in scope.
            - Prefer minimal diff.
            - Do not merge or release.
            - This workflow is docs/architecture lane only: never modify src/, tests/, Cargo.toml, or Cargo.lock.
            - If task type is architecture_rfc:
              - Create or update RFC docs under docs/rfcs/.
              - Keep proposals concrete with problem, options, recommendation, and rollout.
            - If task type is issue_triage:
              - Create or update issue proposals under docs/issues/.
              - Include reproduction, impact, priority, and suggested owner.

      - name: Docs-only structural gate
        if: needs.prepare.outputs.enforce_docs_gate == 'true'
        run: |
          set -euo pipefail
          changed="$(git status --porcelain | awk '{print $2}')"
          echo "Changed files:"
          echo "$changed"

          if [ -z "$changed" ]; then
            echo "Docs gate failed: no changes generated."
            exit 1
          fi

          disallowed="$(echo "$changed" | grep -Ev '^(.github/workflows/gemini-pr\.yml|docs/rfcs/.+\.md|docs/issues/.+\.md|README\.md|GEMINI\.md)$' || true)"
          if [ -n "$disallowed" ]; then
            echo "Docs gate failed: changed files outside docs scope:"
            echo "$disallowed"
            exit 1
          fi

          task_type="${{ needs.prepare.outputs.task_type }}"
          if [ "$task_type" = "architecture_rfc" ]; then
            if ! echo "$changed" | grep -E '^docs/rfcs/.+\.md$' >/dev/null; then
              echo "Docs gate failed: architecture_rfc requires docs/rfcs/*.md changes."
              exit 1
            fi
          fi

          if [ "$task_type" = "issue_triage" ]; then
            if ! echo "$changed" | grep -E '^docs/issues/.+\.md$' >/dev/null; then
              echo "Docs gate failed: issue_triage requires docs/issues/*.md changes."
              exit 1
            fi
          fi

      - name: Ensure docs directories
        run: |
          set -euo pipefail
          mkdir -p docs/issues docs/rfcs

      - name: Fast validation gates
        run: |
          set -euo pipefail
          git diff --name-only
          changed="$(git status --porcelain | awk '{print $2}')"
          if echo "$changed" | grep -E '^(src/|tests/|Cargo\.toml|Cargo\.lock)' >/dev/null; then
            echo "Validation failed: code/runtime files changed in docs-only lane."
            exit 1
          fi

      - name: Reset working tree to base branch before PR action
        run: |
          set -euo pipefail
          git fetch origin "${{ needs.prepare.outputs.base_branch }}"
          git checkout "${{ needs.prepare.outputs.base_branch }}"
          git reset --hard "origin/${{ needs.prepare.outputs.base_branch }}"

      - name: Create Pull Request (Draft)
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ steps.branch.outputs.name }}
          base: ${{ needs.prepare.outputs.base_branch }}
          title: "docs(gemini): ${{ needs.prepare.outputs.scope }}"
          draft: ${{ needs.prepare.outputs.draft == 'true' }}
          commit-message: |
            chore(gemini): ${{ needs.prepare.outputs.scope }}

            AI-Generated: Gemini
            Co-authored-by: Gemini <gemini-noreply@google.com>
          body: |
            ## Summary
            - Scope: `${{ needs.prepare.outputs.scope }}`
            - Trigger: `${{ needs.prepare.outputs.trigger }}`
            - Task type: `${{ needs.prepare.outputs.task_type }}`

            ## Validation Gates
            - [x] docs-only scope gate
            - [x] task-type structural gate

            ## AI Attribution
            - Generated-by: Gemini
            - Workflow: automation-lane
            - Prompt-Scope: `${{ needs.prepare.outputs.scope }}`
            - Human-Reviewer: @${{ needs.prepare.outputs.requester }}

            ## Reviewer Note
            - Please read `GEMINI.md` before approval/merge.

            ## Required Labels
            - ai-generated
            - needs-human-review
            - workflow:gemini
          labels: |
            ai-generated
            needs-human-review
            workflow:gemini
          add-paths: |
            .github/**
            docs/**
            README.md
            GEMINI.md
