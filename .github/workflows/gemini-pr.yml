name: Gemini PR Workflow

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      task_type:
        description: "Task type"
        required: true
        default: "strategy_creation"
        type: choice
        options:
          - strategy_creation
          - general
      scope:
        description: "Scoped task for Gemini (e.g. add ATR strategy tests)"
        required: true
        type: string
      base_branch:
        description: "Base branch to branch from"
        required: false
        default: "main"
        type: string
      draft:
        description: "Create PR as draft"
        required: false
        default: true
        type: boolean
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: gemini-pr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    name: Prepare Trigger Context
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.eval.outputs.should_run }}
      scope: ${{ steps.eval.outputs.scope }}
      base_branch: ${{ steps.eval.outputs.base_branch }}
      draft: ${{ steps.eval.outputs.draft }}
      requester: ${{ steps.eval.outputs.requester }}
      trigger: ${{ steps.eval.outputs.trigger }}
      task_type: ${{ steps.eval.outputs.task_type }}
      enforce_strategy_gate: ${{ steps.eval.outputs.enforce_strategy_gate }}
    steps:
      - name: Evaluate event and authorization
        id: eval
        uses: actions/github-script@v7
        with:
          script: |
            const ev = context.eventName;
            core.setOutput('trigger', ev);
            if (ev === 'workflow_dispatch') {
              const inputs = context.payload.inputs || {};
              const taskType = inputs.task_type || 'strategy_creation';
              core.setOutput('should_run', 'true');
              core.setOutput('task_type', taskType);
              core.setOutput('enforce_strategy_gate', String(taskType === 'strategy_creation'));
              core.setOutput('scope', inputs.scope || 'Implement requested change');
              core.setOutput('base_branch', inputs.base_branch || 'main');
              core.setOutput('draft', String(inputs.draft ?? 'true'));
              core.setOutput('requester', context.actor);
              return;
            }

            if (ev === 'schedule') {
              core.setOutput('should_run', 'true');
              core.setOutput('task_type', 'strategy_creation');
              core.setOutput('enforce_strategy_gate', 'true');
              core.setOutput('scope', 'Daily Gemini maintenance batch');
              core.setOutput('base_branch', 'main');
              core.setOutput('draft', 'true');
              core.setOutput('requester', context.actor || 'github-actions[bot]');
              return;
            }

            if (ev === 'issue_comment') {
              const body = (context.payload.comment?.body || '').trim();
              const assoc = context.payload.comment?.author_association || '';
              const allowed = ['OWNER', 'MEMBER', 'COLLABORATOR'];
              const isIssue = !context.payload.issue?.pull_request;
              if (!isIssue || !body.toLowerCase().startsWith('/gemini-pr') || !allowed.includes(assoc)) {
                core.setOutput('should_run', 'false');
                return;
              }

              const scopeMatch = body.match(/scope\s*=\s*(.+)$/i);
              const scope = scopeMatch ? scopeMatch[1].trim() : 'Implement requested change from issue comment';
              core.setOutput('should_run', 'true');
              core.setOutput('task_type', 'strategy_creation');
              core.setOutput('enforce_strategy_gate', 'true');
              core.setOutput('scope', scope);
              core.setOutput('base_branch', 'main');
              core.setOutput('draft', 'true');
              core.setOutput('requester', context.payload.comment?.user?.login || context.actor);
              return;
            }

            core.setOutput('should_run', 'false');
            core.setOutput('task_type', 'general');
            core.setOutput('enforce_strategy_gate', 'false');

  gemini_pr:
    name: Generate Changes and Open PR
    needs: prepare
    if: needs.prepare.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.base_branch }}
          fetch-depth: 0

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install clippy and rustfmt
        run: rustup component add clippy rustfmt

      - name: Prepare branch name
        id: branch
        run: |
          ts="$(date +%Y%m%d-%H%M%S)"
          safe_scope="$(echo "${{ needs.prepare.outputs.scope }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/-\+/-/g' | sed 's/^-//;s/-$//' | cut -c1-32)"
          if [ -z "$safe_scope" ]; then safe_scope="task"; fi
          echo "name=gemini/${safe_scope}-${ts}" >> "$GITHUB_OUTPUT"

      - name: Run Gemini to apply scoped changes
        uses: google-github-actions/run-gemini-cli@v0
        with:
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            You are working in a Rust repository.
            Task scope: ${{ needs.prepare.outputs.scope }}
            Task type: ${{ needs.prepare.outputs.task_type }}

            Requirements:
            - Keep changes strictly in scope.
            - Prefer minimal diff.
            - Add or update tests under tests/ when behavior changes.
            - Do not merge or release.
            - Keep repository buildable.
            - Do NOT submit trivial test-only changes like tests/smoke_test.rs.
            - If task type is strategy_creation:
              - Add a real strategy implementation under src/strategy/.
              - Register strategy in runtime/catalog paths.
              - Add corresponding tests under tests/*_tests.rs.

      - name: Strategy creation structural gate
        if: needs.prepare.outputs.enforce_strategy_gate == 'true'
        run: |
          set -euo pipefail
          changed="$(git status --porcelain | awk '{print $2}')"
          echo "Changed files:"
          echo "$changed"

          has_strategy_file=0
          has_strategy_test=0
          has_registration=0

          if echo "$changed" | grep -E '^src/strategy/.+\.rs$' >/dev/null; then
            has_strategy_file=1
          fi
          if echo "$changed" | grep -E '^tests/.+_tests\.rs$' >/dev/null; then
            has_strategy_test=1
          fi
          if echo "$changed" | grep -E '^(src/main\.rs|src/strategy_catalog\.rs|src/strategy/mod\.rs)$' >/dev/null; then
            has_registration=1
          fi

          if [ "$has_strategy_file" -ne 1 ] || [ "$has_strategy_test" -ne 1 ] || [ "$has_registration" -ne 1 ]; then
            echo "Strategy gate failed: must include strategy source + strategy tests + registration changes."
            exit 1
          fi

          disallowed="$(echo "$changed" | grep -Ev '^(src/strategy/.+\.rs|src/strategy/mod\.rs|src/main\.rs|src/strategy_catalog\.rs|tests/.+_tests\.rs|docs/rfcs/.+\.md|README\.md|Cargo\.toml|Cargo\.lock)$' || true)"
          if [ -n "$disallowed" ]; then
            echo "Strategy gate failed: changed files outside strategy scope:"
            echo "$disallowed"
            exit 1
          fi

          if echo "$changed" | grep -E '^tests/smoke_test\.rs$' >/dev/null && [ "$(echo "$changed" | wc -l | tr -d ' ')" -le 2 ]; then
            echo "Strategy gate failed: smoke_test-only change is not allowed."
            exit 1
          fi

      - name: Compile-time safety gates
        run: |
          set -euo pipefail
          cargo fmt
          cargo fmt --check
          cargo check --all-targets
          cargo clippy --all-targets -- -D clippy::correctness -D clippy::suspicious
          cargo test -q

      - name: Reset working tree to base branch before PR action
        run: |
          set -euo pipefail
          git fetch origin "${{ needs.prepare.outputs.base_branch }}"
          git checkout "${{ needs.prepare.outputs.base_branch }}"
          git reset --hard "origin/${{ needs.prepare.outputs.base_branch }}"

      - name: Create Pull Request (Draft)
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ${{ steps.branch.outputs.name }}
          base: ${{ needs.prepare.outputs.base_branch }}
          title: "chore(gemini): ${{ needs.prepare.outputs.scope }}"
          draft: ${{ needs.prepare.outputs.draft == 'true' }}
          commit-message: |
            chore(gemini): ${{ needs.prepare.outputs.scope }}

            AI-Generated: Gemini
            Co-authored-by: Gemini <gemini-noreply@google.com>
          body: |
            ## Summary
            - Scope: `${{ needs.prepare.outputs.scope }}`
            - Trigger: `${{ needs.prepare.outputs.trigger }}`
            - Task type: `${{ needs.prepare.outputs.task_type }}`

            ## Compile-time Safety Gates
            - [x] `cargo fmt --check`
            - [x] `cargo check --all-targets`
            - [x] `cargo clippy --all-targets -- -D clippy::correctness -D clippy::suspicious`
            - [x] `cargo test -q`

            ## AI Attribution
            - Generated-by: Gemini
            - Workflow: automation-lane
            - Prompt-Scope: `${{ needs.prepare.outputs.scope }}`
            - Human-Reviewer: @${{ needs.prepare.outputs.requester }}

            ## Reviewer Note
            - Please read `GEMINI.md` before approval/merge.

            ## Required Labels
            - ai-generated
            - needs-human-review
            - workflow:gemini
          labels: |
            ai-generated
            needs-human-review
            workflow:gemini
          add-paths: |
            .github/**
            src/**
            tests/**
            docs/**
            README.md
            GEMINI.md
            Cargo.toml
            Cargo.lock
